name: ðŸ“± Build Android APK - SupaFit

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      LOTTIE_LOGIN: ${{ secrets.LOTTIE_LOGIN }}
      LOTTIE_REGISTER: ${{ secrets.LOTTIE_REGISTER }}

    steps:
    - name: ðŸ§¾ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13.3'

    - name: ðŸ“¦ Instalar dependÃªncias Python do SupaFit
      run: |
        pip install --upgrade pip
        pip install "flet[all]==0.28.3"
        pip install httpx python-dotenv requests supabase flet-lottie flet-video groq openai==1.92.2 pydantic==2.29.0 pydantic-core==2.29.0

    - name: âœ… Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.2'
        channel: stable

    - name: ðŸ”§ Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: ðŸ” Aceitar licenÃ§as do Android
      run: yes | sdkmanager --licenses

    - name: ðŸ”Ž VerificaÃ§Ã£o do Flutter
      run: flutter doctor -v

    - name: ðŸ” Criar arquivo .env para o build
      run: |
        echo "SUPABASE_URL=$SUPABASE_URL" > .env
        echo "SUPABASE_KEY=$SUPABASE_KEY" >> .env
        echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> .env
        echo "GROQ_API_KEY=$GROQ_API_KEY" >> .env
        echo "LOTTIE_LOGIN=$LOTTIE_LOGIN" >> .env
        echo "LOTTIE_REGISTER=$LOTTIE_REGISTER" >> .env

    - name: ðŸ“¦ Criar requirements.txt compatÃ­vel com Android
      run: |
        cat > requirements.txt << EOF
        flet==0.28.3
        httpx
        python-dotenv
        requests
        supabase
        flet-lottie
        flet-video
        groq
        openai==1.92.2
        pydantic==2.29.0
        pydantic-core==2.29.0
        EOF

    - name: ðŸ” Garantir variÃ¡veis no ambiente de build
      run: |
        echo "ðŸ”¸ SUPABASE_URL=$SUPABASE_URL"
        echo "ðŸ”¸ OPENAI_API_KEY=$OPENAI_API_KEY"
        echo "ðŸ”¸ GROQ_API_KEY=$GROQ_API_KEY"

    - name: ðŸ“ Verificar estrutura de arquivos
      run: |
        echo "ðŸ” Verificando estrutura do projeto:"
        ls -la
        echo "ðŸ” Verificando pasta assets:"
        ls -la assets/ || echo "Pasta assets nÃ£o encontrada"
        echo "ðŸ” Verificando pubspec.yaml:"
        cat pubspec.yaml || echo "pubspec.yaml nÃ£o encontrado"
        echo "ðŸ” Verificando requirements.txt:"
        cat requirements.txt

    - name: ðŸš€ Build APK com Flet
      run: |
        flet build apk \
          --project SupaFit \
          --product "SupaFit" \
          --description "App fitness com IA, gerenciamento de treinos e comunidade" \
          --splash-color "#0A1A2F" \
          --splash-dark-color "#0A1A2F" \
          --compile-app \
          --split-per-abi

    - name: ðŸ“ Mostrar arquivos gerados
      run: |
        echo "ðŸ“¦ Estrutura do build:"
        ls -R build/ || echo "Pasta build nÃ£o encontrada"
        
        echo "ðŸ“± APKs gerados:"
        find build/ -name "*.apk" -exec ls -lh {} \; || echo "Nenhum APK encontrado"

    - name: ðŸ“¤ Upload do APK
      uses: actions/upload-artifact@v4
      with:
        name: apk-supafit
        path: build/apk/**/*.apk

    - name: âœ… Finalizado!
      run: echo "APK gerado com sucesso! Verifique na aba Actions â†’ Artifacts"